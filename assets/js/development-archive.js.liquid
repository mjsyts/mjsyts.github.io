---
---
const POSTS = [
  {% for post in site.development reversed %}
  {
    slug: "{{ post.url }}",
    title: "{{ post.title }}",
    date: "{{ post.date | date: '%Y-%m-%d' }}",
    tags: {{ post.tags | jsonify }},
    desc: "{{ post.desc }}",
    image: "{{ post.thumb }}"
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
];

const grid = document.getElementById("grid");
const searchInput = document.getElementById("searchInput");
const sortSelect = document.getElementById("sortSelect");
const tagBar = document.getElementById("tagBar");
const resultsMeta = document.getElementById("resultsMeta");

let activeTag = null;

function render(posts) {
  grid.innerHTML = "";

  posts.forEach(p => {
    const el = document.createElement("article");
    el.className = "archive-card";

    el.innerHTML = `
      <a href="${p.slug}" class="archive-card__link">
        <div class="archive-card__thumb">
          <img src="${p.thumb}" alt="" loading="lazy" />
        </div>
        <div class="archive-card__body">
          <h2 class="archive-card__title">${p.title}</h2>
          <p class="archive-card__desc">${p.desc}</p>
        </div>
      </a>
    `;

    grid.appendChild(el);
  });

  resultsMeta.textContent = `${posts.length} post${posts.length === 1 ? "" : "s"}`;
}

function buildTags() {
  const tags = [...new Set(POSTS.flatMap(p => p.tags))].sort();
  tagBar.innerHTML = "";

  tags.forEach(tag => {
    const btn = document.createElement("button");
    btn.className = "archive-tag";
    btn.textContent = tag;

    btn.onclick = () => {
      activeTag = activeTag === tag ? null : tag;
      update();
    };

    tagBar.appendChild(btn);
  });
}

function update() {
  let out = [...POSTS];

  const q = searchInput.value.toLowerCase();
  if (q) {
    out = out.filter(p =>
      p.title.toLowerCase().includes(q) ||
      p.desc.toLowerCase().includes(q)
    );
  }

  if (activeTag) {
    out = out.filter(p => p.tags.includes(activeTag));
  }

  // Sort
  const sortMode = sortSelect.value;
  if (sortMode === "old") {
    out.sort((a, b) => new Date(a.date) - new Date(b.date));
  } else if (sortMode === "new") {
    out.sort((a, b) => new Date(b.date) - new Date(a.date));
  } else if (sortMode === "az") {
    out.sort((a, b) => a.title.localeCompare(b.title));
  }

  render(out);
}

searchInput.addEventListener("input", update);
sortSelect.addEventListener("change", update);

buildTags();
render(POSTS);